name: Build & Release Termux Background

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  calculate-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.calc-version.outputs.version }}
      tag_name: ${{ steps.calc-version.outputs.tag_name }}
    steps:
      - name: üßæ Checkout repository with tags
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: üî¢ Calculate next semantic version
        id: calc-version
        run: |
          set -euo pipefail
          latest_tag=$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n1)
          
          if [ -z "$latest_tag" ]; then
            new_version="1.0.0"
            echo "üìå No existing tag found. Starting at version 1.0.0"
          else
            version_number="${latest_tag#v}"
            IFS='.' read -r major minor patch <<< "$version_number"
            new_patch=$((patch + 1))
            new_version="$major.$minor.$new_patch"
            echo "üìå Incremented $latest_tag to $new_version"
          fi
          
          echo "version=$new_version" >> "$GITHUB_OUTPUT"
          echo "tag_name=v$new_version" >> "$GITHUB_OUTPUT"

  build-artifacts:
    needs: calculate-version
    runs-on: ubuntu-latest
    outputs:
      deb_path: ${{ steps.artifact-paths.outputs.deb_path }}
      debug_apk: ${{ steps.artifact-paths.outputs.debug_apk }}
      release_apk: ${{ steps.artifact-paths.outputs.release_apk }}
    
    steps:
      - name: üßæ Checkout code
        uses: actions/checkout@v4

      - name: ‚òï Setup Java for Android
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üì¶ Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: "build-tools;34.0.0 platform-tools platforms;android-34 cmdline-tools;latest"

      - name: üîß Make gradlew executable
        run: chmod +x ./gradlew

      - name: üèó Clean and build APKs
        run: |
          set -euo pipefail
          ./gradlew clean
          ./gradlew assembleDebug
          
          echo "Attempting release build..."
          if ./gradlew assembleRelease; then
            echo "‚úÖ Release build command succeeded"
          else
            echo "‚ö† Release build command failed, continuing with available APKs"
          fi
          
          echo "Available APKs:"
          find app/build/outputs/apk/ -name "*.apk" 2>/dev/null | while read f; do
            echo "  - $f"
          done || echo "No APKs found"
          
          # ‚úÖ POLISH: Ensure at least one APK exists before proceeding
          if [ -z "$(find app/build/outputs/apk -name '*.apk' -print -quit)" ]; then
            echo "‚ùå No APK files found in app/build/outputs/apk/"
            echo "Check Android SDK setup and Gradle configuration"
            exit 1
          fi

      - name: üì¶ Create .deb package structure
        run: |
          set -euo pipefail
          rm -rf package
          mkdir -p package/DEBIAN
          mkdir -p package/data/data/com.termux/files/usr/bin
          mkdir -p package/data/data/com.termux/files/usr/share/termux-background/

      - name: üìù Create DEBIAN/control file
        run: |
          set -euo pipefail
          cat > package/DEBIAN/control << EOF
Package: termux-background
Version: ${{ needs.calculate-version.outputs.version }}
Architecture: all
Maintainer: Justadudeinspace
Description: Termux background manager
 A simple utility to set background images in Termux.
EOF

      - name: ‚öôÔ∏è Create main executable script
        run: |
          set -euo pipefail
          cat > package/data/data/com.termux/files/usr/bin/termux-background << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash

TERMUX_DIR="$HOME/.termux"
PROP_FILE="$TERMUX_DIR/termux.properties"
BG_FILE="$TERMUX_DIR/background.png"

case "$1" in
  -h|--help)
    echo "Usage: termux-background <image.png>"
    echo "       termux-background --remove"
    echo "       termux-background --status"
    exit 0
    ;;
  --remove)
    rm -f "$BG_FILE"
    echo "‚úì Background removed"
    exit 0
    ;;
  --status)
    if [ -f "$BG_FILE" ]; then
      echo "Background set: $BG_FILE"
    else
      echo "No background set"
    fi
    exit 0
    ;;
esac

if [ -z "$1" ]; then
  echo "Error: No image specified"
  echo "Usage: termux-background <image.png>"
  exit 1
fi

if [ ! -f "$1" ]; then
  echo "Error: File not found: $1"
  exit 1
fi

mkdir -p "$TERMUX_DIR"
cp "$1" "$BG_FILE"
echo "‚úì Background set to: $BG_FILE"

if [ ! -f "$PROP_FILE" ] || ! grep -q "background=" "$PROP_FILE"; then
  {
    echo "background=background.png"
    echo "background.opacity=0.8"
    echo "background.animation=scroll"
  } >> "$PROP_FILE"
  echo "‚úì Added background settings to termux.properties"
fi

echo "‚Ñπ Run 'termux-reload-settings' to apply changes"
EOF
          
          chmod 755 package/data/data/com.termux/files/usr/bin/termux-background

      - name: üß∞ Install dpkg-deb tooling
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y dpkg-dev

      - name: üì¶ Build .deb package
        run: |
          set -euo pipefail
          dpkg-deb --build -Zgzip package "termux-background_${{ needs.calculate-version.outputs.version }}_all.deb"

      - name: üìä Collect artifact paths
        id: artifact-paths
        run: |
          set -euo pipefail
          DEB_FILE="termux-background_${{ needs.calculate-version.outputs.version }}_all.deb"
          
          DEBUG_APK=$(find app/build/outputs/apk/debug -name "*.apk" 2>/dev/null | head -1 || echo "")
          RELEASE_APK=$(find app/build/outputs/apk/release -name "*.apk" 2>/dev/null | head -1 || echo "")
          
          echo "deb_path=$DEB_FILE" >> $GITHUB_OUTPUT
          echo "debug_apk=$DEBUG_APK" >> $GITHUB_OUTPUT
          echo "release_apk=$RELEASE_APK" >> $GITHUB_OUTPUT
          
          echo "üì¶ Final artifacts:"
          echo "  - $DEB_FILE"
          [ -n "$DEBUG_APK" ] && echo "  - $DEBUG_APK"
          [ -n "$RELEASE_APK" ] && echo "  - $RELEASE_APK"

      - name: ‚¨ÜÔ∏è Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: github-artifacts
          path: |
            termux-background_*.deb
            app/build/outputs/apk/

  create-release:
    needs: [calculate-version, build-artifacts]
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, '[release]'))
    runs-on: ubuntu-latest
    
    steps:
      - name: üßæ Checkout repository (with same commit as build)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.sha }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üè∑Ô∏è Create git tag (with safety check)
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          TAG_NAME="${{ needs.calculate-version.outputs.tag_name }}"
          
          # Safety check: don't delete existing tags - abort instead
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ùå Tag $TAG_NAME already exists. Aborting to avoid rewriting releases."
            echo "If you need a new release, create a new commit or manually delete the tag."
            exit 1
          fi
          
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"
          echo "‚úÖ Tag $TAG_NAME created and pushed"

      - name: ‚è≥ Wait for tag to propagate (with retry)
        run: |
          set -euo pipefail
          # ‚úÖ POLISH: Retry loop for tag propagation
          TAG_NAME="${{ needs.calculate-version.outputs.tag_name }}"
          echo "Waiting for tag $TAG_NAME to propagate..."
          
          for i in 1 2 3 4 5; do
            echo "Attempt $i/5: Checking if tag exists on remote..."
            if git ls-remote --tags origin "$TAG_NAME" | grep -q .; then
              echo "‚úÖ Tag $TAG_NAME found on remote"
              break
            fi
            if [ $i -eq 5 ]; then
              echo "‚ö† Tag $TAG_NAME not found on remote after $i attempts"
              echo "Continuing anyway - release may fail if tag isn't found"
            else
              sleep 3
            fi
          done

      - name: üì• Download artifacts from build job
        uses: actions/download-artifact@v4
        with:
          name: github-artifacts
          path: ./artifacts/

      - name: üöÄ Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.calculate-version.outputs.tag_name }}
          name: "Termux Background ${{ needs.calculate-version.outputs.tag_name }}"
          generate_release_notes: true
          files: |
            artifacts/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
