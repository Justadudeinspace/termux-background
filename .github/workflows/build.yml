on:
  push:
    branches: [main]
  workflow_dispatch:
name: Build & Release Termux Background

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v2

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build Debug APK
        run: ./gradlew assembleDebug

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Build .deb Package
        run: |
          mkdir -p debfix/DEBIAN
          echo "Package: termux-background" > debfix/DEBIAN/control
          echo "Version: 1.0.0" >> debfix/DEBIAN/control
          echo "Architecture: all" >> debfix/DEBIAN/control
          echo "Maintainer: Justadudeinspace" >> debfix/DEBIAN/control
          echo "Description: Termux plugin for custom background image." >> debfix/DEBIAN/control

          mkdir -p debfix/data/data/com.termux/files/usr/bin

      - name: Get Latest Tag
        id: get_tag
        run: |
          latest=$(git tag --sort=-v:refname | grep -E '^v1\.' | tail -n1)
          if [ -z "$latest" ]; then latest="v1.0.0"; fi
          IFS='.' read -r v major minor patch <<<"${latest//v/}"
          tag="v1.$minor.$((patch+1))"
          echo "tag=$tag" >> $GITHUB_OUTPUT

      - name: Create Git Tag
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag ${{ steps.get_tag.outputs.tag }}
          git push origin ${{ steps.get_tag.outputs.tag }}

      - name: Create GitHub Release and Upload
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          files: |
            app/build/outputs/apk/debug/app-debug.apk
            app/build/outputs/apk/release/app-release.apk
            termux-background_1.0.0_all.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          cat << 'EOL' > debfix/data/data/com.termux/files/usr/bin/termux-background
#!/data/data/com.termux/files/usr/bin/bash
mkdir -p ~/.termux
cp -f ~/termux-background/background.png ~/.termux/background.png
grep -q "background=" ~/.termux/termux.properties || {
  echo "background=background.png" >> ~/.termux/termux.properties
  echo "background.opacity=0.8" >> ~/.termux/termux.properties
  echo "background.animation=scroll" >> ~/.termux/termux.properties
}
termux-reload-settings
EOL

          chmod +x debfix/data/data/com.termux/files/usr/bin/termux-background
          dpkg-deb -b debfix termux-background_1.0.0_all.deb
